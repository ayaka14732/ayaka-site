<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-CN" xml:lang="zh-CN" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="ä¸‰æ—¥æœˆç¶¾é¦™" />
  <meta name="keywords" content="æœ€å° PE, PE æ–‡ä»¶, Windows x64, æ±‡ç¼–è¯­è¨€" />
  <title>Windows 10 ä¸‹çš„æœ€å° 64 ä½ PE æ–‡ä»¶</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <link rel="stylesheet" href="/pandoc.css" />
  <link rel="stylesheet" href="/sans.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <!-- Others -->
  <meta property="og:image" content="https://avatars2.githubusercontent.com/u/68557794?s=400&u=343da7bebff676129e87341def71121ebffc4c9c&v=4"/>
  <script>
    window.addEventListener('DOMContentLoaded', function() {
      var xs = document.getElementsByTagName('code');
      for (var i = 0, len = xs.length; i < len; i++)
        xs[i].lang = 'en-x-code';
      xs = document.getElementsByClassName('footnote-back');
      for (var i = 0, len = xs.length; i < len; i++)
        xs[i].lang = 'en-x-code';
      document.querySelectorAll('div.sourceCode > pre').forEach(function(x) {
        x.classList.add('numberSource');
      });
    });
  </script>
  
</head>
<body>
<header id="title-block-header">
<h1 class="title">Windows 10 ä¸‹çš„æœ€å° 64 ä½ PE æ–‡ä»¶</h1>
<p class="author">ä¸‰æ—¥æœˆç¶¾é¦™</p>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#ç®€ä»‹">ç®€ä»‹</a></li>
<li><a href="#å®éªŒç¯å¢ƒ">å®éªŒç¯å¢ƒ</a></li>
<li><a href="#å®éªŒæ­¥éª¤">å®éªŒæ­¥éª¤</a></li>
<li><a href="#å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</a></li>
</ul>
</nav>
<blockquote>
<p>åŒæ—¶å‘å¸ƒäºçŸ¥ä¹ï¼š<a href="https://www.zhihu.com/question/21715980/answer/2239380126">Windows ä¸Šæœ€å°çš„ã€ŒHelloWorld.exeã€èƒ½æœ‰å¤šå°ï¼Ÿ - ä¸‰æ—¥æœˆ ç¶¾é¦™çš„å›ç­”</a></p>
<p>GitHub é“¾æ¥ï¼š<a href="https://github.com/ayaka14732/TinyPE-on-Win10">ayaka14732/TinyPE-on-Win10</a></p>
</blockquote>
<h2 id="ç®€ä»‹">ç®€ä»‹</h2>
<p>æœ¬æ¬¡å®éªŒå°è¯•åˆ¶ä½œäº† Windows 10 æ“ä½œç³»ç»Ÿä¸‹çš„æœ€å° 64 ä½ PE æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å¯ä»¥å¼¹å‡ºå¸¦æœ‰æ–‡å­—æç¤ºçš„æ¶ˆæ¯æ¡†ï¼Œä¸”æ»¡è¶³å®éªŒçš„ä¸‰é¡¹é™åˆ¶æ¡ä»¶ï¼š</p>
<ul>
<li>ç¬¦å·é€šè¿‡å‡½æ•°åï¼ˆè€Œä¸æ˜¯å‡½æ•°åºå·ï¼‰å¼•å…¥</li>
<li>æ¶ˆæ¯æ¡†çš„æ ‡é¢˜å’Œå†…å®¹å­—ç¬¦ä¸²çš„é•¿åº¦ä¸º 64 å­—èŠ‚</li>
<li>æ€»æ–‡ä»¶å¤§å°ä¸è¶…è¿‡ 300 å­—èŠ‚</li>
</ul>
<p>ç»è¿‡ä¹ä¸ªæ­¥éª¤åï¼Œæœ€ç»ˆåˆ¶ä½œå‡ºäº† 268 å­—èŠ‚çš„ PE æ–‡ä»¶ã€‚</p>
<p>å®éªŒæ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ul>
<li>ç¬¬ä¸€æ­¥ï¼šä½¿ç”¨å¸¸è§„æ–¹æ³•ï¼Œåˆ©ç”¨ C è¯­è¨€ç¼–å†™ç¨‹åºï¼Œä½¿ç”¨ MSVC ç¼–è¯‘å™¨ç”Ÿæˆæ™®é€šçš„ PE æ–‡ä»¶ã€‚</li>
<li>ç¬¬äºŒæ­¥ï¼šé€šè¿‡æ”¹å˜ MSVC ç¼–è¯‘å™¨ç¼–è¯‘æ—¶çš„é€‰é¡¹ï¼Œå‡å°ç”Ÿæˆçš„ PE æ–‡ä»¶å¤§å°ã€‚</li>
<li>ç¬¬ä¸‰æ­¥ï¼šä½¿ç”¨ <a href="https://petoolse.github.io/petools/">PE Tools</a> æŸ¥çœ‹ä¸Šä¸€æ­¥äº§ç”Ÿçš„ PE æ–‡ä»¶çš„å†…éƒ¨ç»“æ„ï¼Œå°†å…¶ä¸­ä¸€äº›æ˜æ˜¾æ— ç”¨çš„éƒ¨åˆ†ç½®é›¶ã€‚æ­¤æ—¶æ–‡ä»¶å¤§å°å¹¶æ²¡æœ‰å‡å°ï¼Œä½†æ–‡ä»¶å†…éƒ¨æœ‰äº†æ›´å¤šçš„é›¶ï¼Œè¿™è®©åç»­æ­¥éª¤æœ‰äº†æ›´å¤šçš„å‹ç¼©ç©ºé—´ã€‚</li>
<li>ç¬¬å››æ­¥ï¼šåœ¨ PE æ–‡ä»¶çš„å†…éƒ¨ç»“æ„ä¸­ï¼ŒMS-DOS stub ä¹Ÿæ˜¯æ— ç”¨çš„éƒ¨åˆ†ï¼Œæ‰€ä»¥ä½¿ç”¨äºŒè¿›åˆ¶ç¼–è¾‘å™¨æ‰‹åŠ¨å°†è¿™éƒ¨åˆ†å†…å®¹ç½®é›¶ã€‚è¿™ä¸€æ­¥ä¹Ÿç»™äº†åç»­æ­¥éª¤æ›´å¤šçš„å‹ç¼©ç©ºé—´ã€‚</li>
<li>ç¬¬äº”æ­¥ï¼šè¯¦ç»†åˆ†æ PE æ–‡ä»¶çš„å†…éƒ¨ç»“æ„ï¼Œç†è§£ PE æ–‡ä»¶ä¸­å„éƒ¨åˆ†çš„å«ä¹‰ï¼Œç„¶åä½¿ç”¨æ±‡ç¼–è¯­è¨€æ‰‹åŠ¨ç¼–å†™ä¸€ä¸ªç›¸åŒçš„ PE æ–‡ä»¶ã€‚è™½ç„¶è¿™ä¸€æ­¥ç”Ÿæˆçš„æ–‡ä»¶å’Œä¸Šä¸€æ­¥ç›¸æ¯”æ²¡æœ‰åŒºåˆ«ï¼Œä½†ä½¿ç”¨æ±‡ç¼–è¯­è¨€åï¼Œåç»­æ­¥éª¤å°±æ— éœ€ä¿®æ”¹äºŒè¿›åˆ¶æ–‡ä»¶æœ¬èº«ï¼Œè€Œå¯ä»¥åœ¨æ±‡ç¼–ä»£ç ä¸Šä½œä¿®æ”¹ï¼Œä»è€Œæ›´ç®€ä¾¿åœ°å‡å°æ–‡ä»¶å¤§å°ã€‚</li>
<li>ç¬¬å…­æ­¥ï¼šæ ¹æ®å¯¹ PE æ–‡ä»¶å†…éƒ¨ç»“æ„çš„åˆ†æï¼Œä»æ±‡ç¼–ä»£ç ä¸Šåˆ é™¤æ‰€æœ‰å¯ä»¥ç›´æ¥åˆ é™¤çš„æ— ç”¨éƒ¨åˆ†ï¼Œä»è€Œå‡å°æ–‡ä»¶å¤§å°ã€‚</li>
<li>ç¬¬ä¸ƒæ­¥ï¼šè™½ç„¶åœ¨ä¸Šä¸€æ­¥ä¸­åˆ é™¤äº†æ‰€æœ‰å¯ä»¥ç›´æ¥åˆ é™¤çš„æ— ç”¨éƒ¨åˆ†ï¼Œä½†è¿˜æœ‰ä¸€äº›æ— ç”¨å­—æ®µä¸å¯ä»¥è¢«ç›´æ¥åˆ é™¤ã€‚è¿™æ˜¯å› ä¸º PE æ–‡ä»¶å«æœ‰å¤šä¸ªæ–‡ä»¶å¤´ï¼Œè¿™äº›æ— ç”¨å­—æ®µä½äºæ–‡ä»¶å¤´ä¸­ï¼Œè€Œæ–‡ä»¶å¤´çš„æ ¼å¼æ˜¯å›ºå®šçš„ï¼Œä¹Ÿå°±æ˜¯è¯´å³ä½¿æ–‡ä»¶å¤´ä¸­çš„æŸä¸ªå­—æ®µæ²¡æœ‰è¢«ä½¿ç”¨ï¼Œå®ƒä¹Ÿè¦åœ¨æ–‡ä»¶å¤´ä¸­å æ®ç›¸åº”çš„ä½ç½®ï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥åˆ é™¤ã€‚ä¸ºæ­¤ï¼Œå¯ä»¥é‡‡å–é‡å çš„æ–¹æ³•ï¼Œé€šè¿‡ç²¾å¿ƒé€‰å–åˆé€‚çš„é‡å æ–¹å¼ï¼Œå°†å¤šä¸ªæ–‡ä»¶å¤´é‡å åœ¨ä¸€èµ·ï¼Œå¹¶ä¿è¯é‡å ä¹‹åï¼Œæ¯ä¸ªé‡å çš„ä½ç½®æœ€å¤šåªèƒ½å¯¹åº”ä¸€ä¸ªæœ‰ç”¨å­—æ®µã€‚è¿™æ ·å°±å¯ä»¥åœ¨ä¸ç ´åæ–‡ä»¶å¤´çš„å‰æä¸‹ï¼Œæœ‰æ•ˆåœ°å‡å°æ–‡ä»¶å¤§å°ã€‚</li>
<li>ç¬¬å…«æ­¥ï¼šPE æ–‡ä»¶ä¸­è¿˜å«æœ‰äº”æ¡æŒ‡ä»¤çš„æœºå™¨ç ï¼Œå¦‚æœå°†è¿™äº”æ¡æŒ‡ä»¤çš„æœºå™¨ç ä¹ŸæŒ‰ä¸Šä¸€æ­¥çš„æ–¹æ³•ä¸æ–‡ä»¶å¤´é‡å ï¼Œå°±å¯ä»¥è¿›ä¸€æ­¥å‡å°æ–‡ä»¶çš„å¤§å°ã€‚ä½†æ˜¯ï¼ŒæŒ‡ä»¤çš„æœºå™¨ç å¤ªé•¿ï¼Œæ²¡æœ‰åŠæ³•åšåˆ°ã€Œè§ç¼æ’é’ˆã€ï¼Œæ”¾å…¥æ–‡ä»¶å¤´æ— ç”¨å­—æ®µçš„ç©ºéš™ä¸­ã€‚ä¸ºæ­¤ï¼Œæƒ³åˆ°å¯ä»¥å°†äº”æ¡æŒ‡ä»¤æ‹†å¼€ï¼Œå¹¶åœ¨å‰å››æ¡æŒ‡ä»¤çš„åé¢åˆ†åˆ«åŠ ä¸€æ¡çŸ­è·³è½¬æŒ‡ä»¤è·³åˆ°ä¸‹ä¸€æ¡æŒ‡ä»¤çš„ä½ç½®ï¼Œè¿™æ ·æ¯æ¡æŒ‡ä»¤å°±å¯ä»¥ä½œä¸ºä¸€ä¸ªç‹¬ç«‹çš„éƒ¨åˆ†æ’å…¥åˆ°ä¸åŒçš„ç©ºéš™ä¸­äº†ã€‚ç„¶è€Œï¼Œå³ä½¿è¿™æ ·åšä»ç„¶æœ‰ä¸¤æ¡æŒ‡ä»¤å¤ªé•¿ï¼Œæ²¡æœ‰åŠæ³•æ’å…¥ç©ºéš™ã€‚è¿™æ—¶ï¼Œé€šè¿‡å¯¹ x64 æŒ‡ä»¤é›†çš„æ·±å…¥å­¦ä¹ å’Œå……åˆ†æŒæ¡ï¼Œæƒ³åˆ°åœ¨è¿™ä¸¤æ¡æŒ‡ä»¤ä»¥å¦ä¸€ä¸ªå¯„å­˜å™¨ä½œä¸ºåŸºå€æ—¶ï¼Œå¯ä»¥ä½¿å¯¹åº”çš„æœºå™¨ç æ›´çŸ­ï¼Œè€ŒæŒ‡ä»¤ç»“æœä¸å˜ã€‚è¿™æ ·æœºå™¨ç ä¹Ÿæ’å…¥åˆ°äº†æ–‡ä»¶å¤´æ— ç”¨å­—æ®µçš„ç©ºéš™ä¸­ï¼Œä»è€Œè¿›ä¸€æ­¥å‡å°äº†æ–‡ä»¶å¤§å°ã€‚</li>
<li>ç¬¬ä¹æ­¥ï¼šåˆ é™¤æ–‡ä»¶æœ«å°¾çš„ 0ï¼Œå› ä¸ºç¨‹åºåŠ è½½æ—¶ä¼šåœ¨æœ«å°¾è‡ªåŠ¨å¡«å……é›¶ã€‚</li>
</ul>
<table>
<thead>
<tr class="header">
<th style="text-align: left;">æ­¥éª¤</th>
<th style="text-align: left;">æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰</th>
<th style="text-align: left;">ç†µ</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">1</td>
<td style="text-align: left;">94208</td>
<td style="text-align: left;">5.924863</td>
</tr>
<tr class="even">
<td style="text-align: left;">2</td>
<td style="text-align: left;">896</td>
<td style="text-align: left;">3.567715</td>
</tr>
<tr class="odd">
<td style="text-align: left;">3</td>
<td style="text-align: left;">896</td>
<td style="text-align: left;">2.220567</td>
</tr>
<tr class="even">
<td style="text-align: left;">4</td>
<td style="text-align: left;">896</td>
<td style="text-align: left;">1.608427</td>
</tr>
<tr class="odd">
<td style="text-align: left;">5</td>
<td style="text-align: left;">896</td>
<td style="text-align: left;">1.607880</td>
</tr>
<tr class="even">
<td style="text-align: left;">6</td>
<td style="text-align: left;">448</td>
<td style="text-align: left;">2.653766</td>
</tr>
<tr class="odd">
<td style="text-align: left;">7</td>
<td style="text-align: left;">308</td>
<td style="text-align: left;">2.473451</td>
</tr>
<tr class="even">
<td style="text-align: left;">8</td>
<td style="text-align: left;">280</td>
<td style="text-align: left;">2.620173</td>
</tr>
<tr class="odd">
<td style="text-align: left;">9</td>
<td style="text-align: left;">268</td>
<td style="text-align: left;">2.667864</td>
</tr>
</tbody>
</table>
<p>å…¶ä¸­ï¼Œç¬¬ 3-5 æ­¥è™½ç„¶æ–‡ä»¶å¤§å°æ²¡æœ‰å‡å°ï¼Œä½†æ–‡ä»¶çš„ç†µå‡å°äº†ï¼Œè¿™è¯´æ˜æ–‡ä»¶å†…éƒ¨æœ‰æ›´å¤šçš„é›¶ï¼Œä¹Ÿå°±è¯´æ˜åç»­æ­¥éª¤æœ‰æ›´å¤šçš„å‹ç¼©ç©ºé—´ã€‚</p>
<h2 id="å®éªŒç¯å¢ƒ">å®éªŒç¯å¢ƒ</h2>
<ul>
<li>æ“ä½œç³»ç»Ÿï¼šMicrosoft Windows 10 Version 1903 (v10.0.18362.239) 64-bit</li>
<li>Shellï¼šzsh 5.7.1 (x86_64-pc-msys)</li>
<li>C ç¼–è¯‘å™¨ï¼šMicrosoft (R) C/C++ Optimizing Compiler Version 19.22.27905 for x64</li>
<li>è¿æ¥å™¨ï¼šMicrosoft (R) Incremental Linker Version 14.22.27905.0</li>
<li>æ±‡ç¼–å™¨ï¼šNASM version 2.14.02 compiled on Jan 30 2019</li>
<li>è°ƒè¯•å™¨ï¼šx64dbg May 19 2019, 18:13:13</li>
</ul>
<h2 id="å®éªŒæ­¥éª¤">å®éªŒæ­¥éª¤</h2>
<p><strong>ç¬¬ä¸€æ­¥ï¼šä½¿ç”¨å¸¸è§„æ–¹æ³•ï¼Œåˆ©ç”¨ C è¯­è¨€ç¼–å†™ç¨‹åºï¼Œä½¿ç”¨ MSVC ç¼–è¯‘å™¨ç”Ÿæˆæ™®é€šçš„ PE æ–‡ä»¶ã€‚</strong></p>
<p>åœ¨ Windows ç¼–ç¨‹ä¸­ï¼Œè¦å¼¹å‡ºæ¶ˆæ¯æ¡†ï¼Œå¯ä»¥ä½¿ç”¨ <a href="https://docs.microsoft.com/en-us/windows/desktop/api/winuser/nf-winuser-messageboxa"><code>MessageBoxA</code></a> æˆ– <a href="https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-messageboxw"><code>MessageBoxW</code></a> è¿™ä¸¤ä¸ªå‡½æ•°ã€‚å…¶ä¸­ï¼Œå‡½æ•°åä»¥ A ç»“å°¾è¡¨ç¤ºå­—ç¬¦ç¼–ç ä½¿ç”¨ç”¨æˆ·çš„å½“å‰ä»£ç é¡µï¼Œä»¥ W ç»“å°¾è¡¨ç¤ºä½¿ç”¨ UTF-16ã€‚</p>
<p>ç”±äºç”¨æˆ·ä½¿ç”¨çš„ä»£ç é¡µå¹¶ä¸ç»Ÿä¸€ï¼Œå‡ºäºå…¼å®¹æ€§çš„è€ƒè™‘ï¼Œæœ¬æ¬¡å®éªŒä½¿ç”¨ä»¥ W ç»“å°¾çš„ <code>MessageBoxW</code> å‡½æ•°ã€‚ä»£ç é¡µçš„é—®é¢˜å…¶å®éå¸¸å¸¸è§ï¼Œç›¸ä¿¡è®¸å¤šäººåœ¨ Windows ä¸Šä½¿ç”¨ Python ç¼–ç¨‹æ—¶ï¼Œéƒ½é‡åˆ°è¿‡å› ä¸ºä»£ç é¡µä¸å¯¹è€Œå¯¼è‡´ç¨‹åºä¹±ç æˆ–å´©æºƒçš„é—®é¢˜ã€‚è¿™é‡Œä½¿ç”¨ <code>MessageBoxW</code> å‡½æ•°ï¼Œä¸ä»£ç é¡µæ— å…³ï¼Œæ‰€ä»¥å¯ä»¥é¿å…ç¨‹åºä¹±ç æˆ–å´©æºƒã€‚</p>
<p>ç¼–å†™çš„ C è¯­è¨€ä»£ç  <code>tiny.c</code> å¦‚ä¸‹ï¼š</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Windows.h&gt;</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main() {</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    MessageBoxW( NULL <span class="co">/* hWnd */</span>,</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>                 L<span class="st">&quot;ABCDEFG&quot;</span> <span class="co">/* lpText, 16 bytes */</span>,</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>                 L<span class="st">&quot;ğŸ’¯ TinyPE on Windows 10&quot;</span> <span class="co">/* lpCaption, 48 bytes */</span>,</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>                 MB_ICONASTERISK | MB_TOPMOST | MB_SERVICE_NOTIFICATION <span class="co">/* uType */</span> );</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span>;</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>æ¥ä¸‹æ¥å°† C è¯­è¨€ä»£ç ç¼–è¯‘ä¸º PE æ–‡ä»¶ã€‚</p>
<p>å®‰è£… Visual Studio Build Tools 2019 åï¼Œã€Œå¼€å§‹ã€èœå•ä¸­ä¼šå‡ºç° Visual Studio 2019 æ–‡ä»¶å¤¹ã€‚ç‚¹å‡»å…¶ä¸­çš„ x64 Native Tools Command Prompt for VS 2019 æ‰“å¼€å‘½ä»¤è¡Œï¼Œåˆ‡æ¢åˆ°å½“å‰ç›®å½•åï¼Œè¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼š</p>
<pre class="cmd"><code>&gt; cl /O1 /source-charset:utf-8 tiny.c /link /SUBSYSTEM:WINDOWS /ENTRY:mainCRTStartup user32.lib
Microsoft (R) C/C++ Optimizing Compiler Version 19.22.27905 for x64
Copyright (C) Microsoft Corporation.  All rights reserved.

tiny.c
Microsoft (R) Incremental Linker Version 14.22.27905.0
Copyright (C) Microsoft Corporation.  All rights reserved.

/out:tiny.exe
/SUBSYSTEM:WINDOWS
/ENTRY:mainCRTStartup
user32.lib
tiny.obj</code></pre>
<p>ç¼–è¯‘ç”Ÿæˆ <code>tiny.exe</code> æ–‡ä»¶ï¼Œå¯ä»¥æ­£å¸¸è¿è¡Œï¼š</p>
<p><img src="tiny1.exe.png" /></p>
<p><strong>ç¬¬äºŒæ­¥ï¼šé€šè¿‡æ”¹å˜ MSVC ç¼–è¯‘å™¨ç¼–è¯‘æ—¶çš„é€‰é¡¹ï¼Œå‡å°ç”Ÿæˆçš„ PE æ–‡ä»¶å¤§å°ã€‚</strong></p>
<p>å‚è€ƒ <a href="https://blogs.msdn.microsoft.com/xiangfan/2008/09/19/minimize-the-size-of-your-program-high-level/">Minimize the size of your program â€“ high level</a> å’Œ <a href="https://docs.microsoft.com/en-us/cpp/build/reference/linker-options?view=vs-2019">Linker Options</a> å¯çŸ¥ï¼Œé€šè¿‡ä¿®æ”¹ C è¯­è¨€ä»£ç å’Œç¼–è¯‘é€‰é¡¹ï¼Œå¯ä»¥å‡å°ç¼–è¯‘ç”Ÿæˆçš„ PE æ–‡ä»¶å¤§å°ã€‚</p>
<p>ä¿®æ”¹åçš„ C è¯­è¨€ä»£ç  <code>tiny.c</code> å¦‚ä¸‹ï¼š</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Windows.h&gt;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> _() {</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    MessageBoxW( NULL <span class="co">/* hWnd */</span>,</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>                 L<span class="st">&quot;ABCDEFG&quot;</span> <span class="co">/* lpText, 16 bytes */</span>,</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>                 L<span class="st">&quot;ğŸ’¯ TinyPE on Windows 10&quot;</span> <span class="co">/* lpCaption, 48 bytes */</span>,</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>                 MB_ICONASTERISK | MB_TOPMOST | MB_SERVICE_NOTIFICATION <span class="co">/* uType */</span> );</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¡Œé€‰é¡¹ç¼–è¯‘ï¼š</p>
<pre class="cmd"><code>&gt; cl /O1 /MD /GS- /source-charset:utf-8 tiny.c /link /NOLOGO /NODEFAULTLIB /SUBSYSTEM:WINDOWS /ENTRY:_ /MERGE:.rdata=. /MERGE:.pdata=. /MERGE:.text=. /SECTION:.,ER /ALIGN:16 user32.lib
Microsoft (R) C/C++ Optimizing Compiler Version 19.22.27905 for x64
Copyright (C) Microsoft Corporation.  All rights reserved.

tiny.c
LINK : warning LNK4108: /ALIGN specified without /DRIVER; image may not run
LINK : warning LNK4254: section &#39;.text&#39; (60000020) merged into &#39;.&#39; (40000040) with different attributes</code></pre>
<p>ç¼–è¯‘ç”Ÿæˆ <code>tiny.exe</code> æ–‡ä»¶ï¼Œå¯ä»¥æ­£å¸¸è¿è¡Œã€‚</p>
<p><strong>ç¬¬ä¸‰æ­¥ï¼šä½¿ç”¨ <a href="https://petoolse.github.io/petools/">PE Tools</a> æŸ¥çœ‹ä¸Šä¸€æ­¥äº§ç”Ÿçš„ PE æ–‡ä»¶çš„å†…éƒ¨ç»“æ„ï¼Œå°†å…¶ä¸­ä¸€äº›æ˜æ˜¾æ— ç”¨çš„éƒ¨åˆ†ç½®é›¶ã€‚æ­¤æ—¶æ–‡ä»¶å¤§å°å¹¶æ²¡æœ‰å‡å°ï¼Œä½†æ–‡ä»¶å†…éƒ¨æœ‰äº†æ›´å¤šçš„é›¶ï¼Œè¿™è®©åç»­æ­¥éª¤æœ‰äº†æ›´å¤šçš„å‹ç¼©ç©ºé—´ã€‚</strong></p>
<p>æ‰“å¼€ PE Tools (v1.9.762.2018)ï¼Œå•å‡»â€œPE Editorâ€ï¼Œç„¶åæ‰“å¼€ <code>tiny.exe</code>ã€‚</p>
<p><img src="tiny2.exe.png" /></p>
<p>æ‰¾åˆ°ä»¥ä¸‹ä¸‰ä¸ªéƒ¨åˆ†ï¼Œå¹¶ç½®é›¶ï¼š</p>
<ul>
<li>ç‚¹å‡»â€œFile Headerâ€ï¼Œæ‰¾åˆ°â€œTime/Dateâ€ï¼Œè®¾ç½®ä¸º 0</li>
<li>ç‚¹å‡»â€œView Richâ€ï¼Œç„¶åç‚¹å‡»â€œClear Signâ€</li>
<li>ç‚¹å‡»â€œDirectoriesâ€ï¼Œæ‰¾åˆ°â€œDebug Directoryâ€ï¼Œç‚¹å‡»â€œâ€¦â€ï¼Œç„¶åç‚¹å‡»â€œClear debug infoâ€</li>
</ul>
<p>ä¿®æ”¹åçš„ <code>tiny.exe</code> æ–‡ä»¶å¯ä»¥æ­£å¸¸è¿è¡Œã€‚</p>
<p><strong>ç¬¬å››æ­¥ï¼šåœ¨ PE æ–‡ä»¶çš„å†…éƒ¨ç»“æ„ä¸­ï¼ŒMS-DOS stub ä¹Ÿæ˜¯æ— ç”¨çš„éƒ¨åˆ†ï¼Œæ‰€ä»¥ä½¿ç”¨äºŒè¿›åˆ¶ç¼–è¾‘å™¨æ‰‹åŠ¨å°†è¿™éƒ¨åˆ†å†…å®¹ç½®é›¶ã€‚è¿™ä¸€æ­¥ä¹Ÿç»™äº†åç»­æ­¥éª¤æ›´å¤šçš„å‹ç¼©ç©ºé—´ã€‚</strong></p>
<p>ä½¿ç”¨äºŒè¿›åˆ¶ç¼–è¾‘å™¨æ‰“å¼€ <code>tiny.exe</code>ã€‚</p>
<p>å®šä½åˆ°ä»¥ä¸‹éƒ¨åˆ†ï¼Œå¹¶ç½®é›¶ï¼š</p>
<ul>
<li>å°† <code>0x02-0x3b</code> ç½®é›¶</li>
<li>å°† <code>0x40-0x7f</code> ç½®é›¶</li>
</ul>
<p>è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œ<code>0x00-0x01</code> æ˜¯ <code>e_magic</code>ï¼Œ<code>0x3c-0x3f</code> æ˜¯ <code>e_lfanew</code>ï¼Œå®ƒä»¬éƒ½æ˜¯æœ‰ç”¨çš„å­—æ®µï¼Œæ‰€ä»¥æ²¡æœ‰ç½®é›¶ã€‚</p>
<p>ä¿®æ”¹åçš„ <code>tiny.exe</code> æ–‡ä»¶å¯ä»¥æ­£å¸¸è¿è¡Œï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode zsh"><code class="sourceCode zsh"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>$ xxd -p tiny.exe</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>4d5a00000000000000000000000000000000000000000000000000000000</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>000000000000000000000000000000000000000000000000000000000000</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>c00000000000000000000000000000000000000000000000000000000000</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>000000000000000000000000000000000000000000000000000000000000</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>000000000000000000000000000000000000000000000000000000000000</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>000000000000000000000000000000000000000000000000000000000000</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>000000000000000000000000504500006486010000000000000000000000</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>0000f00022000b020e1690010000000000000000000000030000f0010000</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>000000400100000010000000100000000600000000000000060000000000</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>000080030000f00100000000000002006081000010000000000000100000</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>000000000000100000000000001000000000000000000000100000000000</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>000000000000200300002800000000000000000000000000000000000000</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>000000000000000000000000000000000000000000000000000000000000</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>000000000000000000000000000000000000000000000000000000000000</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>00000000f001000010000000000000000000000000000000000000000000</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>0000000000002e0000000000000082010000f001000090010000f0010000</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>000000000000000000000000200000605803000000000000000000000000</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>00003dd8afdc2000540069006e0079005000450020006f006e0020005700</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>69006e0064006f0077007300200031003000000041004200430044004500</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>460047000000000000000000000000000000000000000000000000000000</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>000000000000000000000000000000000000000000000000000000000000</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>000000000000000000000000000000000000000000000000000000000000</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>000000000000000000000000000000000000000000000000000000000000</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>000000000000000000000000000000000000000000000000000000000000</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>000000000000000000000000000000000000000000000000000000000000</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>00000000000000000000000000000000000041b9400024004c8d05f3feff</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>ff488d151cffffff33c948ff25d3feffffcccccc48030000000000000000</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>000066030000f00100000000000000000000000000000000000000000000</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>5803000000000000000000000000000094024d657373616765426f785700</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>5553455233322e646c6c00000000000000000000000000000000</span></code></pre></div>
<p>å¯ä»¥ä½¿ç”¨ <code>xxd -p -r</code> å°†ä»¥ä¸Šæ–‡æœ¬è½¬æ¢å›äºŒè¿›åˆ¶æ–‡ä»¶ã€‚</p>
<p><strong>ç¬¬äº”æ­¥ï¼šè¯¦ç»†åˆ†æ PE æ–‡ä»¶çš„å†…éƒ¨ç»“æ„ï¼Œç†è§£ PE æ–‡ä»¶ä¸­å„éƒ¨åˆ†çš„å«ä¹‰ï¼Œç„¶åä½¿ç”¨æ±‡ç¼–è¯­è¨€æ‰‹åŠ¨ç¼–å†™ä¸€ä¸ªç›¸åŒçš„ PE æ–‡ä»¶ã€‚è™½ç„¶è¿™ä¸€æ­¥ç”Ÿæˆçš„æ–‡ä»¶å’Œä¸Šä¸€æ­¥ç›¸æ¯”æ²¡æœ‰åŒºåˆ«ï¼Œä½†ä½¿ç”¨æ±‡ç¼–è¯­è¨€åï¼Œåç»­æ­¥éª¤å°±æ— éœ€ä¿®æ”¹äºŒè¿›åˆ¶æ–‡ä»¶æœ¬èº«ï¼Œè€Œå¯ä»¥åœ¨æ±‡ç¼–ä»£ç ä¸Šä½œä¿®æ”¹ï¼Œä»è€Œæ›´ç®€ä¾¿åœ°å‡å°æ–‡ä»¶å¤§å°ã€‚</strong></p>
<p>åœ¨ç†è§£ PE æ–‡ä»¶çš„ç»“æ„æ—¶ï¼Œä¸»è¦å‚è€ƒäº†ä»¥ä¸‹èµ„æ–™ï¼š</p>
<ul>
<li>æ€»è¿°ï¼š<a href="https://docs.microsoft.com/en-us/windows/desktop/Debug/pe-format">PE Format</a>ï¼Œ<a href="https://en.wikibooks.org/wiki/X86_Disassembly/Windows_Executable_Files">x86 Disassembly/Windows Executable Files</a>ï¼Œ<a href="https://blog.kowalczyk.info/articles/pefileformat.html">Portable Executable File Format</a></li>
<li>Rich headerï¼š<a href="http://bytepointer.com/articles/the_microsoft_rich_header.htm">The Undocumented Microsoft â€œRichâ€ Header</a></li>
<li>Import address tableï¼š<a href="https://reverseengineering.stackexchange.com/a/16872">Import table vs Import Address Table</a></li>
</ul>
<p>å¦å¤–ï¼Œè¿˜ä½¿ç”¨äº† <a href="https://petoolse.github.io/petools/">PE Tools</a> å’Œ <a href="http://www.codedebug.com/php/Products/Products_NikPEViewer_20v.php">PE Disassembler viewer</a> è¿™ä¸¤ä¸ªå·¥å…·ã€‚</p>
<p>åœ¨ç†è§£ PE æ–‡ä»¶çš„ç»“æ„åï¼Œä½¿ç”¨æ±‡ç¼–è¯­è¨€æ‰‹åŠ¨ç¼–å†™ä¸€ä¸ªç›¸åŒçš„ PE æ–‡ä»¶ã€‚</p>
<p>åœ¨ç¼–å†™æ±‡ç¼–è¯­è¨€æ—¶ï¼Œè¦ç‰¹åˆ«æ³¨æ„ä¸èƒ½ä½¿ç”¨ç¡¬ç¼–ç çš„æ•°å€¼ï¼Œè€Œæ˜¯è¦ä½¿ç”¨ä¼ªæŒ‡ä»¤è®¡ç®—å¾—å‡ºç›¸åº”çš„æ•°å€¼ã€‚ä¾‹å¦‚ï¼Œæ–‡ä»¶å¤§å°çš„æ•°å€¼ <code>0x0380</code> ä½¿ç”¨ <code>file_size equ $-$$</code> æ›¿æ¢ï¼Œæœºå™¨æŒ‡ä»¤ <code>0x41b940002400</code> ä½¿ç”¨ <code>mov r9d, 0x00240040</code> æ›¿æ¢ã€‚è¿™æ˜¯å› ä¸ºå¦‚æœä½¿ç”¨äº†ç¡¬ç¼–ç çš„æ•°å€¼ï¼Œåç»­æ­¥éª¤ä¸­ PE æ–‡ä»¶çš„ç»“æ„å‘ç”Ÿå˜åŒ–æ—¶ï¼Œè¿™äº›æ•°å€¼å¹¶ä¸ä¼šéšä¹‹æ”¹å˜ï¼Œæ–‡ä»¶å°±ä¼šæŸåã€‚</p>
<p>æ­¤å¤–ï¼Œåœ¨ä½¿ç”¨ NASM æ±‡ç¼–å™¨æ—¶ï¼Œæ ¹æ®<a href="https://www.nasm.us/doc/nasmdoc3.html#section-3.2.1">å®˜æ–¹æ–‡æ¡£</a>ï¼Œåˆ†åˆ«ä½¿ç”¨ä¼ªæŒ‡ä»¤ <code>db</code>ã€<code>dw</code>ã€<code>dd</code>ã€<code>dq</code> å£°æ˜ 1ã€2ã€4ã€8 å­—èŠ‚çš„æ•°æ®ã€‚</p>
<p>ç¼–å†™çš„æ±‡ç¼–è¯­è¨€æ–‡ä»¶ <code>stretch.asm</code> å¦‚ä¸‹ï¼š</p>
<pre class="assembly"><code>BITS 64

%define align(n,r) (((n+(r-1))/r)*r)

; DOS Header
    dw &#39;MZ&#39;                 ; e_magic
    dw 0                    ; [UNUSED] e_cblp
    dw 0                    ; [UNUSED] c_cp
    dw 0                    ; [UNUSED] e_crlc
    dw 0                    ; [UNUSED] e_cparhdr
    dw 0                    ; [UNUSED] e_minalloc
    dw 0                    ; [UNUSED] e_maxalloc
    dw 0                    ; [UNUSED] e_ss
    dw 0                    ; [UNUSED] e_sp
    dw 0                    ; [UNUSED] e_csum
    dw 0                    ; [UNUSED] e_ip
    dw 0                    ; [UNUSED] e_cs
    dw 0                    ; [UNUSED] e_lfarlc
    dw 0                    ; [UNUSED] e_ovno
    times 4 dw 0            ; [UNUSED] e_res
    dw 0                    ; [UNUSED] e_oemid
    dw 0                    ; [UNUSED] e_oeminfo
    times 10 dw 0           ; [UNUSED] e_res2
    dd pe_hdr               ; e_lfanew

; DOS Stub
    times 8 dq 0            ; [UNUSED] DOS Stub

; Rich Header
    times 8 dq 0            ; [UNUSED] Rich Header

; PE Header
pe_hdr:
    dw &#39;PE&#39;, 0              ; Signature

; Image File Header
    dw 0x8664               ; Machine
    dw 0x01                 ; NumberOfSections
    dd 0                    ; [UNUSED] TimeDateStamp
    dd 0                    ; PointerToSymbolTable
    dd 0                    ; NumberOfSymbols
    dw opt_hdr_size         ; SizeOfOptionalHeader
    dw 0x22                 ; Characteristics

; Optional Header, COFF Standard Fields
opt_hdr:
    dw 0x020b               ; Magic (PE32+)
    db 0x0e                 ; MajorLinkerVersion
    db 0x16                 ; MinorLinkerVersion
    dd code_size            ; SizeOfCode
    dd 0                    ; SizeOfInitializedData
    dd 0                    ; SizeOfUninitializedData
    dd entry                ; AddressOfEntryPoint
    dd iatbl                ; BaseOfCode

; Optional Header, NT Additional Fields
    dq 0x000140000000       ; ImageBase
    dd 0x10                 ; SectionAlignment
    dd 0x10                 ; FileAlignment
    dw 0x06                 ; MajorOperatingSystemVersion
    dw 0                    ; MinorOperatingSystemVersion
    dw 0                    ; MajorImageVersion
    dw 0                    ; MinorImageVersion
    dw 0x06                 ; MajorSubsystemVersion
    dw 0                    ; MinorSubsystemVersion
    dd 0                    ; Reserved1
    dd file_size            ; SizeOfImage
    dd hdr_size             ; SizeOfHeaders
    dd 0                    ; CheckSum
    dw 0x02                 ; Subsystem (Windows GUI)
    dw 0x8160               ; DllCharacteristics
    dq 0x100000             ; SizeOfStackReserve
    dq 0x1000               ; SizeOfStackCommit
    dq 0x100000             ; SizeOfHeapReserve
    dq 0x1000               ; SizeOfHeapCommit
    dd 0                    ; LoaderFlags
    dd 0x10                 ; NumberOfRvaAndSizes

; Optional Header, Data Directories
    dd 0                    ; Export, RVA
    dd 0                    ; Export, Size
    dd itbl                 ; Import, RVA
    dd itbl_size            ; Import, Size
    dd 0                    ; Resource, RVA
    dd 0                    ; Resource, Size
    dd 0                    ; Exception, RVA
    dd 0                    ; Exception, Size
    dd 0                    ; Certificate, RVA
    dd 0                    ; Certificate, Size
    dd 0                    ; Base Relocation, RVA
    dd 0                    ; Base Relocation, Size
    dd 0                    ; Debug, RVA
    dd 0                    ; Debug, Size
    dd 0                    ; Architecture, RVA
    dd 0                    ; Architecture, Size
    dd 0                    ; Global Ptr, RVA
    dd 0                    ; Global Ptr, Size
    dd 0                    ; TLS, RVA
    dd 0                    ; TLS, Size
    dd 0                    ; Load Config, RVA
    dd 0                    ; Load Config, Size
    dd 0                    ; Bound Import, RVA
    dd 0                    ; Bound Import, Size
    dd iatbl                ; IAT, RVA
    dd iatbl_size           ; IAT, Size
    dd 0                    ; Delay Import Descriptor, RVA
    dd 0                    ; Delay Import Descriptor, Size
    dd 0                    ; CLR Runtime Header, RVA
    dd 0                    ; CLR Runtime Header, Size
    dd 0                    ; Reserved, RVA
    dd 0                    ; Reserved, Size

opt_hdr_size equ $-opt_hdr

; Section Table
    section_name db &#39;.&#39;     ; Name
    times 8-($-section_name) db 0
    dd sect_size            ; VirtualSize
    dd iatbl                ; VirtualAddress
    dd code_size            ; SizeOfRawData
    dd iatbl                ; PointerToRawData
    dd 0                    ; PointerToRelocations
    dd 0                    ; PointerToLinenumbers
    dw 0                    ; NumberOfRelocations
    dw 0                    ; NumberOfLinenumbers
    dd 0x60000020           ; Characteristics

hdr_size equ $-$$

code:
; Import Address Directory
iatbl:
    dq symbol
    dq 0

iatbl_size equ $-iatbl

; Strings
title:
    db 0x3d,0xd8,0xaf,0xdc,0x20,0x00,0x54,0x00
    db 0x69,0x00,0x6e,0x00,0x79,0x00,0x50,0x00
    db 0x45,0x00,0x20,0x00,0x6f,0x00,0x6e,0x00
    db 0x20,0x00,0x57,0x00,0x69,0x00,0x6e,0x00
    db 0x64,0x00,0x6f,0x00,0x77,0x00,0x73,0x00
    db 0x20,0x00,0x31,0x00,0x30,0x00,0,0
content:
    db 0x41,0x00,0x42,0x00,0x43,0x00,0x44,0x00
    db 0x45,0x00,0x46,0x00,0x47,0x00,0,0

; Debug Table
    times 24 dq 0           ; [UNUSED] Debug Table

; Entry
entry:
    mov r9d, 0x00240040     ; uType
    lea r8, [rel title]     ; lpCaption
    lea rdx, [rel content]  ; lpText
    xor ecx, ecx            ; hWnd
    jmp [rel iatbl]         ; MessageBoxW

    times align($-$$,16)-($-$$) db 0xcc

; Import Directory
itbl:
    dq intbl                ; OriginalFirstThunk
    dd 0                    ; TimeDateStamp
    dd dll_name             ; ForwarderChain
    dd iatbl                ; Name
    dq 0                    ; FirstThunk

    times 3 dd 0

itbl_size equ $-itbl

; Import Name Table
intbl:
    dq symbol
    dq 0

; Symbol
symbol:
    dw 0x0294               ; [UNUSED] Function Order
    db &#39;MessageBoxW&#39;, 0     ; Function Name
dll_name:
    db &#39;USER32.dll&#39;, 0
    db 0

sect_size equ $-code

    times align($-$$,16)-($-$$) db 0

code_size equ $-code
file_size equ $-$$</code></pre>
<p>ç¼–è¯‘ï¼š</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode zsh"><code class="sourceCode zsh"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>$ nasm -f bin -o stretch.exe -l stretch.lst stretch.asm</span></code></pre></div>
<p>ç¼–è¯‘ç”Ÿæˆ <code>stretch.exe</code>ï¼Œå¯ä»¥æ­£å¸¸è¿è¡Œã€‚</p>
<p>è¿™æ—¶å‘ç°ï¼Œè™½ç„¶ <code>stretch.exe</code> æ˜¯å‚ç…§ <code>tiny.exe</code> æ‰‹åŠ¨ç¼–å†™çš„ï¼Œç†è®ºä¸Šåº”è¯¥å®Œå…¨ç›¸åŒï¼Œä½†æ˜¯å®é™…ä¸Šä¸¤è€…ç•¥æœ‰åŒºåˆ«ï¼š</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode zsh"><code class="sourceCode zsh"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>$ diff =<span class="kw">(</span>xxd step4/tiny.exe<span class="kw">)</span> =<span class="kw">(</span>xxd step5/stretch.exe<span class="kw">)</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>50c50</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;</span> 00000310: 1cff ffff 33c9 48ff 25d3 feff ffcc cccc  ....3.H.%.......</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="kw">&gt;</span> 00000310: 1cff ffff 31c9 ff25 d4fe ffff cccc cccc  ....1..%........</span></code></pre></div>
<p><code>xor ecx, ecx</code> æŒ‡ä»¤åœ¨ <code>tiny.exe</code> ä¸­ä»¥æœºå™¨ç  <code>0x33c9</code> è¡¨ç¤ºï¼Œè€Œåœ¨ <code>stretch.exe</code> ä¸­ä»¥ <code>0x31c9</code> è¡¨ç¤ºã€‚ç”± <a href="https://www.felixcloutier.com/x86/xor">XOR â€” Logical Exclusive OR</a> å¯çŸ¥ï¼Œè¿™æ˜¯ç”±äºæŒ‡ä»¤ç¼–ç æ–¹å¼ä¸åŒï¼Œä¸å½±å“æŒ‡ä»¤çš„æ•ˆæœï¼š</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode zsh"><code class="sourceCode zsh"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>$ <span class="kw">echo</span> 33c9 <span class="kw">|</span> xxd -p -r <span class="kw">-</span> <span class="kw">|</span> ndisasm -b 64 <span class="kw">-</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>00000000  33C9              xor ecx,ecx</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>$ <span class="kw">echo</span> 31c9 <span class="kw">|</span> xxd -p -r <span class="kw">-</span> <span class="kw">|</span> ndisasm -b 64 <span class="kw">-</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>00000000  31C9              xor ecx,ecx</span></code></pre></div>
<p><code>jmp [rel iatbl]</code> æŒ‡ä»¤åœ¨ <code>tiny.exe</code> ä¸­ä»¥æœºå™¨ç  <code>0x48ff25d3feffff</code> è¡¨ç¤ºï¼Œè€Œåœ¨ <code>stretch.exe</code> ä¸­ä»¥ <code>0xff25d4feffff</code> è¡¨ç¤ºã€‚è¿™ä¸¤æ¡æŒ‡ä»¤çš„è·³è½¬åœ°å€æ²¡æœ‰åŒºåˆ«ï¼š</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode zsh"><code class="sourceCode zsh"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>$ <span class="kw">echo</span> 48ff25d3feffff <span class="kw">|</span> xxd -p -r <span class="kw">-</span> <span class="kw">|</span> ndisasm -b 64 <span class="kw">-</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>00000000  48FF25D3FEFFFF    jmp qword [rel 0xfffffffffffffeda]</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>$ <span class="kw">echo</span> ff25d4feffff <span class="kw">|</span> xxd -p -r <span class="kw">-</span> <span class="kw">|</span> ndisasm -b 64 <span class="kw">-</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>00000000  FF25D4FEFFFF      jmp [rel 0xfffffffffffffeda]</span></code></pre></div>
<p>ç”± Stack Overflow ä¸Šçš„<a href="https://stackoverflow.com/a/36800114">ä¸€ä¸ªå›ç­”</a>å¯çŸ¥ï¼Œæœºå™¨ç ä¸­çš„ <code>48</code> å‰ç¼€è¡¨ç¤º REX.Wï¼Œä¼šè¢«å¤„ç†å™¨å¿½ç•¥ã€‚è¿™ä¸€å‰ç¼€å¯èƒ½ä¸ Windows x64 çš„ unwind data æœ‰å…³ã€‚ä¸è®ºå¦‚ä½•ï¼Œä»è¿è¡Œç»“æœä¸Šçœ‹ï¼Œè¿™ä¸€ä¿®æ”¹ä¸å½±å“æŒ‡ä»¤çš„æ•ˆæœã€‚</p>
<p>ç”±æ­¤å¯çŸ¥ï¼Œè¿™ä¸€æ­¥ä½¿ç”¨æ±‡ç¼–è¯­è¨€ç¼–å†™çš„ <code>stretch.exe</code> å’Œä¸Šä¸€æ­¥çš„ <code>tiny.exe</code> æ˜¯ç­‰ä»·çš„ã€‚</p>
<p><strong>ç¬¬å…­æ­¥ï¼šæ ¹æ®å¯¹ PE æ–‡ä»¶å†…éƒ¨ç»“æ„çš„åˆ†æï¼Œä»æ±‡ç¼–ä»£ç ä¸Šåˆ é™¤æ‰€æœ‰å¯ä»¥ç›´æ¥åˆ é™¤çš„æ— ç”¨éƒ¨åˆ†ï¼Œä»è€Œå‡å°æ–‡ä»¶å¤§å°ã€‚</strong></p>
<p>åˆ é™¤çš„éƒ¨åˆ†å¦‚ä¸‹ï¼š</p>
<ul>
<li>åˆ é™¤ DOS stubã€Rich header å’Œ debug table</li>
<li>å¯¹äº optional header çš„ data directories ä¸­çš„ 16 é¡¹ï¼Œä»…ä¿ç•™å‰ 2 é¡¹ï¼Œå¹¶å°† <code>NumberOfRvaAndSizes</code> è®¾ç½®ä¸º 2</li>
<li>åˆ é™¤ <code>itbl</code> åç”¨äºå¯¹é½çš„å­—èŠ‚</li>
</ul>
<p>ä¿®æ”¹åçš„ <code>stretch.asm</code> å¦‚ä¸‹ï¼š</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode zsh"><code class="sourceCode zsh"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>$ diff step5/stretch.asm step6/stretch.asm</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>26,31d25</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;</span> ; DOS Stub</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;</span>     <span class="kw">times</span> 8 dq 0            ; [UNUSED] DOS Stub</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;</span> </span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;</span> ; Rich Header</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;</span>     <span class="kw">times</span> 8 dq 0            ; [UNUSED] Rich Header</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;</span> </span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>77c71</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;</span>     dd 0x10                 ; NumberOfRvaAndSizes</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="kw">&gt;</span>     dd 0x02                 ; NumberOfRvaAndSizes</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>84,111d77</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;</span>     dd 0                    ; Resource, RVA</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;</span>     dd 0                    ; Resource, Size</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;</span>     dd 0                    ; Exception, RVA</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;</span>     dd 0                    ; Exception, Size</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;</span>     dd 0                    ; Certificate, RVA</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;</span>     dd 0                    ; Certificate, Size</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;</span>     dd 0                    ; Base Relocation, RVA</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;</span>     dd 0                    ; Base Relocation, Size</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;</span>     dd 0                    ; Debug, RVA</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;</span>     dd 0                    ; Debug, Size</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;</span>     dd 0                    ; Architecture, RVA</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;</span>     dd 0                    ; Architecture, Size</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;</span>     dd 0                    ; Global Ptr, RVA</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;</span>     dd 0                    ; Global Ptr, Size</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;</span>     dd 0                    ; TLS, RVA</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;</span>     dd 0                    ; TLS, Size</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;</span>     dd 0                    ; Load Config, RVA</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;</span>     dd 0                    ; Load Config, Size</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;</span>     dd 0                    ; Bound Import, RVA</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;</span>     dd 0                    ; Bound Import, Size</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;</span>     dd iatbl                ; IAT, RVA</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;</span>     dd iatbl_size           ; IAT, Size</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;</span>     dd 0                    ; Delay Import Descriptor, RVA</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;</span>     dd 0                    ; Delay Import Descriptor, Size</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;</span>     dd 0                    ; CLR Runtime Header, RVA</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;</span>     dd 0                    ; CLR Runtime Header, Size</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;</span>     dd 0                    ; Reserved, RVA</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;</span>     dd 0                    ; Reserved, Size</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>150,152d115</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;</span> ; Debug Table</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;</span>     <span class="kw">times</span> 24 dq 0           ; [UNUSED] Debug Table</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;</span> </span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>170,171d132</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;</span> </span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;</span>     <span class="kw">times</span> 3 dd 0</span></code></pre></div>
<p>ç¼–è¯‘ï¼š</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode zsh"><code class="sourceCode zsh"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>$ nasm -f bin -o stretch.exe -l stretch.lst stretch.asm</span></code></pre></div>
<p>ç¼–è¯‘ç”Ÿæˆ <code>stretch.exe</code>ï¼Œå¯ä»¥æ­£å¸¸è¿è¡Œã€‚</p>
<p><strong>ç¬¬ä¸ƒæ­¥ï¼šè™½ç„¶åœ¨ä¸Šä¸€æ­¥ä¸­åˆ é™¤äº†æ‰€æœ‰å¯ä»¥ç›´æ¥åˆ é™¤çš„æ— ç”¨éƒ¨åˆ†ï¼Œä½†è¿˜æœ‰ä¸€äº›æ— ç”¨å­—æ®µä¸å¯ä»¥è¢«ç›´æ¥åˆ é™¤ã€‚è¿™æ˜¯å› ä¸º PE æ–‡ä»¶å«æœ‰å¤šä¸ªæ–‡ä»¶å¤´ï¼Œè¿™äº›æ— ç”¨å­—æ®µä½äºæ–‡ä»¶å¤´ä¸­ï¼Œè€Œæ–‡ä»¶å¤´çš„æ ¼å¼æ˜¯å›ºå®šçš„ï¼Œä¹Ÿå°±æ˜¯è¯´å³ä½¿æ–‡ä»¶å¤´ä¸­çš„æŸä¸ªå­—æ®µæ²¡æœ‰è¢«ä½¿ç”¨ï¼Œå®ƒä¹Ÿè¦åœ¨æ–‡ä»¶å¤´ä¸­å æ®ç›¸åº”çš„ä½ç½®ï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥åˆ é™¤ã€‚ä¸ºæ­¤ï¼Œå¯ä»¥é‡‡å–é‡å çš„æ–¹æ³•ï¼Œé€šè¿‡ç²¾å¿ƒé€‰å–åˆé€‚çš„é‡å æ–¹å¼ï¼Œå°†å¤šä¸ªæ–‡ä»¶å¤´é‡å åœ¨ä¸€èµ·ï¼Œå¹¶ä¿è¯é‡å ä¹‹åï¼Œæ¯ä¸ªé‡å çš„ä½ç½®æœ€å¤šåªèƒ½å¯¹åº”ä¸€ä¸ªæœ‰ç”¨å­—æ®µã€‚è¿™æ ·å°±å¯ä»¥åœ¨ä¸ç ´åæ–‡ä»¶å¤´çš„å‰æä¸‹ï¼Œæœ‰æ•ˆåœ°å‡å°æ–‡ä»¶å¤§å°ã€‚</strong></p>
<p>è¦åˆ¤æ–­ä¸€ä¸ªå­—æ®µæ˜¯å¦æ˜¯æœ‰ç”¨å­—æ®µï¼Œå¯ä»¥é‡‡ç”¨ä¿®æ”¹çš„æ–¹æ³•ï¼Œæ¯”å¦‚å°†å­—æ®µçš„å€¼ä¿®æ”¹ä¸º 0ã€‚å¦‚æœä¿®æ”¹ä»¥åç¨‹åºå‡ºç°é—®é¢˜ï¼Œåˆ™è¯´æ˜è¯¥å­—æ®µæ˜¯æœ‰ç”¨å­—æ®µï¼Œå¦åˆ™æ˜¯æ— ç”¨å­—æ®µã€‚</p>
<p>åˆ¤æ–­å‡ºæœ‰ç”¨å­—æ®µå’Œæ— ç”¨å­—æ®µåï¼Œå¯ä»¥å°†æœ‰ç”¨å­—æ®µä¸æ— ç”¨å­—æ®µç›¸äº’é‡å ï¼Œä»è€Œå‡å°æ–‡ä»¶å¤§å°ã€‚ä¾‹å¦‚ï¼Œå°† PE header çš„èµ·å§‹ä½ç½®è®¾ç½®ä¸º DOS header çš„ <code>0x04</code> å¤„ï¼Œå¯ä»¥å°†ä¸¤ä¸ªæ–‡ä»¶å¤´çš„å­—æ®µé‡å ã€‚é‡å æ—¶å¯èƒ½å­˜åœ¨å¤šç§ä¸åŒçš„é‡å æ–¹æ³•ï¼Œæœ¬æ¬¡å®éªŒåªé€‰æ‹©å…¶ä¸­ä¸€ç§æ–¹æ³•ã€‚</p>
<p>å¦å¤–ï¼Œè™½ç„¶ Import table å’Œ DLLFuncEntry éƒ½æ˜¯æœ‰ç”¨å­—æ®µï¼Œä½†æ˜¯ä¸¤è€…å¯ä»¥é‡å ã€‚è¿™æ˜¯å› ä¸º Import table åªåœ¨ç¨‹åºåŠ è½½å‰ä½¿ç”¨ï¼ŒDLLFuncEntry åªåœ¨ç¨‹åºåŠ è½½åä½¿ç”¨ï¼Œæ‰€ä»¥å¹¶ä¸ä¼šäº§ç”Ÿå†²çªã€‚</p>
<p>é‡å åçš„ <code>stretch.asm</code> å¦‚ä¸‹ï¼š</p>
<pre class="assembly"><code>BITS 64

                            ; DOS Header
    dw &#39;MZ&#39;                 ; e_magic
    dw 0                    ; [UNUSED] e_cblp
pe_hdr:                                                 ; PE Header
    dw &#39;PE&#39;                 ; [UNUSED] c_cp             ; Signature
    dw 0                    ; [UNUSED] e_crlc           ; Signature (Cont)
                                                        ; Image File Header
    dw 0x8664               ; [UNUSED] e_cparhdr        ; Machine
code:
symbol:                                                                                     ; Symbol
    dw 0x01                 ; [UNUSED] e_minalloc       ; NumberOfSections                  ; [UNUSED] Function Order
    db &#39;MessageBoxW&#39;, 0                                                                     ; Function Name
    times 14-($-symbol) db 0; [UNUSED] e_maxalloc       ; [UNUSED] TimeDateStamp
                            ; [UNUSED] e_ss             ; [UNUSED] TimeDateStamp (Cont)
                            ; [UNUSED] e_sp             ; [UNUSED] PointerToSymbolTable
                            ; [UNUSED] e_csum           ; [UNUSED] PointerToSymbolTable (Cont)
                            ; [UNUSED] e_ip             ; [UNUSED] NumberOfSymbols
                            ; [UNUSED] e_cs             ; [UNUSED] NumberOfSymbols (Cont)
    dw opt_hdr_size         ; [UNUSED] e_lfarlc         ; SizeOfOptionalHeader
    dw 0x22                 ; [UNUSED] e_ovno           ; Characteristics
opt_hdr:                                                ; Optional Header, COFF Standard Fields
    dw 0x020b               ; [UNUSED] e_res            ; Magic (PE32+)
    db 0                    ; [UNUSED] e_res (Cont)     ; [UNUSED] MajorLinkerVersion
    db 0                    ; [UNUSED] e_res (Cont)     ; [UNUSED] MinorLinkerVersion
    dd code_size            ; [UNUSED] e_res (Cont)     ; SizeOfCode
    dw 0                    ; [UNUSED] e_oemid          ; [UNUSED] SizeOfInitializedData
    dw 0                    ; [UNUSED] e_oeminfo        ; [UNUSED] SizeOfInitializedData (Cont)
    dd 0                    ; [UNUSED] e_res2           ; [UNUSED] SizeOfUninitializedData
    dd entry                ; [UNUSED] e_res2 (Cont)    ; AddressOfEntryPoint
    dd code                 ; [UNUSED] e_res2 (Cont)    ; BaseOfCode
                                                        ; Optional Header, NT Additional Fields
    dq 0x000140000000       ; [UNUSED] e_res2 (Cont)    ; ImageBase
    dd pe_hdr               ; e_lfanew                  ; [MODIFIED] SectionAlignment (0x10 -&gt; 0x04)
    dd 0x04                                             ; [MODIFIED] FileAlignment (0x10)
    dw 0x06                                             ; [UNUSED] MajorOperatingSystemVersion
    dw 0                                                ; [UNUSED] MinorOperatingSystemVersion
    dw 0                                                ; [UNUSED] MajorImageVersion
    dw 0                                                ; [UNUSED] MinorImageVersion
    dw 0x06                                             ; MajorSubsystemVersion
    dw 0                                                ; MinorSubsystemVersion
    dd 0                                                ; [UNUSED] Reserved1
    dd file_size                                        ; SizeOfImage
    dd hdr_size                                         ; SizeOfHeaders
    dd 0                                                ; [UNUSED] CheckSum
    dw 0x02                                             ; Subsystem (Windows GUI)
    dw 0x8160                                           ; DllCharacteristics
    dq 0x100000                                         ; SizeOfStackReserve
    dq 0x1000                                           ; SizeOfStackCommit
    dq 0x100000                                         ; SizeOfHeapReserve
dll_name:                                                                                   ; DLLName
    db &#39;USER32.dll&#39;, 0                                                                      ; DLLName
    times 12-($-dll_name) db 0                          ; [UNUSED] SizeOfHeapCommit
                                                        ; [UNUSED] LoaderFlags
    dd 0x02                                             ; [MODIFIED] NumberOfRvaAndSizes (0x10)

; Optional Header, Data Directories
    dd 0                    ; [UNUSED] Export, RVA
    dd 0                    ; [UNUSED] Export, Size
iatbl:                                                  ; Import Address Directory
    dd itbl                 ; Import, RVA               ; [USEDAFTERLOAD] DLLFuncEntry
    dd itbl_size            ; Import, Size              ; [USEDAFTERLOAD] DLLFuncEntry (Cont)
iatbl_size equ $-iatbl

opt_hdr_size equ $-opt_hdr

                            ; Section Table
    section_name db &#39;.&#39;, 0  ; Name
    times 8-($-section_name) db 0
    dd sect_size            ; VirtualSize
    dd iatbl                ; VirtualAddress
    dd code_size            ; SizeOfRawData
    dd iatbl                ; PointerToRawData
content:                                                ; Strings
    db 0x41,0x00,0x42,0x00,0x43,0x00,0x44,0x00
    db 0x45,0x00,0x46,0x00,0x47,0x00,0,0
                            ; [UNUSED] PointerToRelocations
                            ; [UNUSED] PointerToLinenumbers
                            ; [UNUSED] NumberOfRelocations
                            ; [UNUSED] NumberOfLinenumbers
                            ; [UNUSED] Characteristics
hdr_size equ $-$$

title:
    db 0x3d,0xd8,0xaf,0xdc,0x20,0x00,0x54,0x00
    db 0x69,0x00,0x6e,0x00,0x79,0x00,0x50,0x00
    db 0x45,0x00,0x20,0x00,0x6f,0x00,0x6e,0x00
    db 0x20,0x00,0x57,0x00,0x69,0x00,0x6e,0x00
    db 0x64,0x00,0x6f,0x00,0x77,0x00,0x73,0x00
    db 0x20,0x00,0x31,0x00,0x30,0x00,0,0

; Entry
entry:
    mov r9d, 0x00240040     ; uType
    lea r8, [rel title]     ; lpCaption
    lea rdx, [rel content]  ; lpText
    xor ecx, ecx            ; hWnd
    jmp [rel iatbl]         ; MessageBoxW

itbl:                       ; Import Directory
    dq intbl                ; OriginalFirstThunk
    dd 0                    ; [UNUSED] TimeDateStamp
    dd dll_name             ; ForwarderChain
    dd iatbl                ; Name
intbl:                                                  ; Import Name Table
    dq symbol               ; [UNUSED] FirstThunk       ; Symbol
    dq 0                                                ; nullptr
itbl_size equ $-itbl

sect_size equ $-code
code_size equ $-code
file_size equ $-$$</code></pre>
<p>ç¼–è¯‘ï¼š</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode zsh"><code class="sourceCode zsh"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>$ nasm -f bin -o stretch.exe -l stretch.lst stretch.asm</span></code></pre></div>
<p>ç¼–è¯‘ç”Ÿæˆ <code>stretch.exe</code>ï¼Œå¯ä»¥æ­£å¸¸è¿è¡Œã€‚</p>
<p><strong>ç¬¬å…«æ­¥ï¼šPE æ–‡ä»¶ä¸­è¿˜å«æœ‰äº”æ¡æŒ‡ä»¤çš„æœºå™¨ç ï¼Œå¦‚æœå°†è¿™äº”æ¡æŒ‡ä»¤çš„æœºå™¨ç ä¹ŸæŒ‰ä¸Šä¸€æ­¥çš„æ–¹æ³•ä¸æ–‡ä»¶å¤´é‡å ï¼Œå°±å¯ä»¥è¿›ä¸€æ­¥å‡å°æ–‡ä»¶çš„å¤§å°ã€‚ä½†æ˜¯ï¼ŒæŒ‡ä»¤çš„æœºå™¨ç å¤ªé•¿ï¼Œæ²¡æœ‰åŠæ³•åšåˆ°ã€Œè§ç¼æ’é’ˆã€ï¼Œæ”¾å…¥æ–‡ä»¶å¤´æ— ç”¨å­—æ®µçš„ç©ºéš™ä¸­ã€‚ä¸ºæ­¤ï¼Œæƒ³åˆ°å¯ä»¥å°†äº”æ¡æŒ‡ä»¤æ‹†å¼€ï¼Œå¹¶åœ¨å‰å››æ¡æŒ‡ä»¤çš„åé¢åˆ†åˆ«åŠ ä¸€æ¡çŸ­è·³è½¬æŒ‡ä»¤è·³åˆ°ä¸‹ä¸€æ¡æŒ‡ä»¤çš„ä½ç½®ï¼Œè¿™æ ·æ¯æ¡æŒ‡ä»¤å°±å¯ä»¥ä½œä¸ºä¸€ä¸ªç‹¬ç«‹çš„éƒ¨åˆ†æ’å…¥åˆ°ä¸åŒçš„ç©ºéš™ä¸­äº†ã€‚ç„¶è€Œï¼Œå³ä½¿è¿™æ ·åšä»ç„¶æœ‰ä¸¤æ¡æŒ‡ä»¤å¤ªé•¿ï¼Œæ²¡æœ‰åŠæ³•æ’å…¥ç©ºéš™ã€‚è¿™æ—¶ï¼Œé€šè¿‡å¯¹ x64 æŒ‡ä»¤é›†çš„æ·±å…¥å­¦ä¹ å’Œå……åˆ†æŒæ¡ï¼Œæƒ³åˆ°åœ¨è¿™ä¸¤æ¡æŒ‡ä»¤ä»¥å¦ä¸€ä¸ªå¯„å­˜å™¨ä½œä¸ºåŸºå€æ—¶ï¼Œå¯ä»¥ä½¿å¯¹åº”çš„æœºå™¨ç æ›´çŸ­ï¼Œè€ŒæŒ‡ä»¤ç»“æœä¸å˜ã€‚è¿™æ ·æœºå™¨ç ä¹Ÿæ’å…¥åˆ°äº†æ–‡ä»¶å¤´æ— ç”¨å­—æ®µçš„ç©ºéš™ä¸­ï¼Œä»è€Œè¿›ä¸€æ­¥å‡å°äº†æ–‡ä»¶å¤§å°ã€‚</strong></p>
<p>åœ¨ä¸Šä¸€æ­¥éª¤ä¸­ï¼Œèƒ½é‡å çš„å­—æ®µéƒ½å·²ç»è¢«é‡å äº†ï¼Œè€ŒæŒ‡ä»¤çš„æœºå™¨ç è¿˜æ²¡æœ‰ä½œè¿‡å˜åŒ–ï¼š</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode zsh"><code class="sourceCode zsh"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>$ grep -A 5 entry: stretch.lst</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    94                                  entry:</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    95 000000F4 41B940002400                mov r9d, 0x00240040     ; uType</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    96 000000FA 4C8D05C3FFFFFF              lea r8, [rel title]     ; lpCaption</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    97 00000101 488D15ACFFFFFF              lea rdx, [rel content]  ; lpText</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    98 00000108 31C9                        xor ecx, ecx            ; hWnd</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    99 0000010A FF2584FFFFFF                jmp [rel iatbl]         ; MessageBoxW</span></code></pre></div>
<p>å…¶ä¸­ï¼Œå‰å››æ¡æŒ‡ä»¤ç”¨äºå‡½æ•°è°ƒç”¨çš„å‚æ•°ä¼ é€’ã€‚æ ¹æ® <a href="https://docs.microsoft.com/en-us/cpp/build/x64-calling-convention?view=vs-2019">x64 calling convention</a>ï¼Œåœ¨ Windows x64 ä¸­ï¼Œå‡½æ•°çš„å‰å››ä¸ªå‚æ•°åˆ†åˆ«ä½¿ç”¨ RCXã€RDXã€R8 å’Œ R9 ä¼ é€’ï¼Œåªæœ‰å½“å‚æ•°å¤§äºå››ä¸ªæ—¶æ‰ä½¿ç”¨å †æ ˆä¼ é€’ã€‚<code>MessageBoxW</code> çš„ <code>hWnd</code> å’Œ <code>uType</code> ä¸¤ä¸ªå‚æ•°çš„é•¿åº¦ä¸º 32 ä½è€Œä¸æ˜¯ 64 ä½ï¼Œæ‰€ä»¥è¦å°† RCX æ›¿æ¢ä¸º ECXã€R9 æ›¿æ¢ä¸º R9Dã€‚ç¬¬äº”æ¡æŒ‡ä»¤æ˜¯è·³è½¬æŒ‡ä»¤ï¼Œä¸ºäº†å‡å° PE æ–‡ä»¶çš„å¤§å°ï¼Œä¸å¿…å¤„ç† <code>MessageBoxW</code> å‡½æ•°çš„è¿”å›å€¼ï¼Œç›´æ¥ä½¿ç”¨ <code>jmp</code> æŒ‡ä»¤è·³è½¬åˆ°ç›®æ ‡å‡½æ•°ã€‚</p>
<p>è¿™äº”æ¡æŒ‡ä»¤çš„æœºå™¨ç ä½œä¸ºä¸€ä¸ªæ•´ä½“å…±å  28 å­—èŠ‚ï¼Œä½†ä¸Šä¸€æ­¥ç»è¿‡ä¸€ç•ªé‡å ï¼Œæœ€å¤§çš„æ— ç”¨å­—æ®µä¹Ÿåªæœ‰ 8 å­—èŠ‚ã€‚å› æ­¤ï¼Œæ²¡æœ‰åŠæ³•åšåˆ°ã€Œè§ç¼æ’é’ˆã€ï¼Œå°†æœºå™¨ç æ”¾å…¥æ–‡ä»¶å¤´æ— ç”¨å­—æ®µçš„ç©ºéš™ä¸­ã€‚è¿™æ—¶ï¼Œæƒ³åˆ°å¯ä»¥å°†æŒ‡ä»¤æ‹†å¼€ï¼Œç„¶ååœ¨å‰å››æ¡æŒ‡ä»¤çš„åé¢åˆ†åˆ«åŠ ä¸€æ¡çŸ­è·³è½¬æŒ‡ä»¤è·³åˆ°ä¸‹ä¸€æ¡æŒ‡ä»¤çš„ä½ç½®ã€‚ç”± <a href="https://www.felixcloutier.com/x86/jmp">JMP â€” Jump</a> å¯çŸ¥ï¼ŒçŸ­è·³è½¬æŒ‡ä»¤çš„è·³è½¬èŒƒå›´å¯ä»¥è¾¾åˆ° â€“128 è‡³ +127ï¼Œè€Œæœºå™¨ç åªå  2 ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥è¿™ç§åšæ³•æ˜¯å¯è¡Œçš„ã€‚</p>
<table>
<thead>
<tr class="header">
<th style="text-align: left;">æ±‡ç¼–æŒ‡ä»¤</th>
<th style="text-align: left;">æœºå™¨ç é•¿åº¦</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>mov r9d, 0x00240040</code> + <code>jmp</code></td>
<td style="text-align: left;">8</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>lea r8, [rel title]</code> + <code>jmp</code></td>
<td style="text-align: left;">9</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>lea rdx, [rel content]</code> + <code>jmp</code></td>
<td style="text-align: left;">9</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>xor ecx, ecx</code> + <code>jmp</code></td>
<td style="text-align: left;">4</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>jmp [rel iatbl]</code></td>
<td style="text-align: left;">6</td>
</tr>
</tbody>
</table>
<p>ä½†æ˜¯ï¼Œé€šè¿‡ä¸Šè¡¨å¯ä»¥çœ‹å‡ºï¼Œä¸¤æ¡ <code>lea</code> æŒ‡ä»¤çš„æœºå™¨ç ä»å  9 ä¸ªå­—èŠ‚ã€‚è€Œä¸Šé¢æåˆ°ï¼Œæœ€å¤§çš„æ— ç”¨å­—æ®µä¹Ÿåªæœ‰ 8 å­—èŠ‚ï¼Œæ‰€ä»¥å¯¹äºè¿™ä¸¤æ¡æŒ‡ä»¤ï¼Œä»ç„¶æ²¡åŠæ³•åšåˆ°ã€Œè§ç¼æ’é’ˆã€ã€‚</p>
<p>åœ¨ <a href="https://x64dbg.com/">x64dbg</a> ä¸­è°ƒè¯•æ—¶å‘ç°ï¼Œå½“ç¨‹åºæ‰§è¡Œåˆ°ç”¨æˆ·ä»£ç çš„å…¥å£ç‚¹æ—¶ï¼ŒRDX å¯„å­˜å™¨çš„å€¼ä¼šè¢«è®¾ç½®ä¸ºå…¥å£åœ°å€ï¼š</p>
<p><img src="rdx.png" /></p>
<p>è¿™æ—¶ï¼Œé€šè¿‡å¯¹ x64 æŒ‡ä»¤é›†çš„æ·±å…¥å­¦ä¹ å’Œå……åˆ†æŒæ¡ï¼Œæ„è¯†åˆ°åœ¨ <code>lea</code> æŒ‡ä»¤ä¸­ï¼Œå¦‚æœä»¥ RDX å¯„å­˜å™¨ä½œä¸ºåŸºå€ï¼Œå¯ä»¥ä½¿å¯¹åº”çš„æœºå™¨ç æ›´çŸ­ã€‚RDX å¯„å­˜å™¨çš„å€¼è¢«è®¾ç½®ä¸ºå…¥å£åœ°å€ï¼Œä¹Ÿå°±æ˜¯è¯´ RDX å¯„å­˜å™¨çš„å€¼ä¸æ˜¯éšæœºçš„ï¼Œä¹Ÿå°±å…·å¤‡äº†ä½œåŸºå€çš„æ¡ä»¶ã€‚</p>
<p>åœ¨åŸæ¥çš„ç¨‹åºä¸­ï¼Œä»¥ RIP å¯„å­˜å™¨ä½œä¸ºåŸºå€ï¼Œå¯¹åº”çš„æœºå™¨ç é•¿åº¦ä¸º 7ï¼š</p>
<table>
<thead>
<tr class="header">
<th style="text-align: left;">æ±‡ç¼–æŒ‡ä»¤</th>
<th style="text-align: left;">æœºå™¨ç </th>
<th style="text-align: left;">é•¿åº¦</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>lea r8, [rip-0x4d]</code></td>
<td style="text-align: left;"><code>0x4c8d05b3ffffff</code></td>
<td style="text-align: left;">7</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>lea rdx, [rip-0x44]</code></td>
<td style="text-align: left;"><code>0x488d15bcffffff</code></td>
<td style="text-align: left;">7</td>
</tr>
</tbody>
</table>
<p>è€Œä»¥ RDX å¯„å­˜å™¨ä½œä¸ºåŸºå€æ—¶ï¼Œå¯¹åº”çš„æœºå™¨ç é•¿åº¦ä»…ä¸º 4ï¼š</p>
<table>
<thead>
<tr class="header">
<th style="text-align: left;">æ±‡ç¼–æŒ‡ä»¤</th>
<th style="text-align: left;">æœºå™¨ç </th>
<th style="text-align: left;">é•¿åº¦</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>lea r8, [rdx-0x4d]</code></td>
<td style="text-align: left;"><code>0x4c8d42b3</code></td>
<td style="text-align: left;">4</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>lea rdx, [rdx-0x44]</code></td>
<td style="text-align: left;"><code>0x488d52bc</code></td>
<td style="text-align: left;">4</td>
</tr>
</tbody>
</table>
<p>å› æ­¤ï¼Œå°†ä¸¤æ¡ <code>lea</code> æŒ‡ä»¤æ”¹ä¸ºä»¥ RDX å¯„å­˜å™¨ä½œä¸ºåŸºå€ã€‚ä¿®æ”¹åçš„æ±‡ç¼–æŒ‡ä»¤å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr class="header">
<th style="text-align: left;">æ±‡ç¼–æŒ‡ä»¤</th>
<th style="text-align: left;">æœºå™¨ç é•¿åº¦</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>mov r9d, 0x00240040</code> + <code>jmp</code></td>
<td style="text-align: left;">8</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>lea r8, [rdx+title-entry]</code> + <code>jmp</code></td>
<td style="text-align: left;">6</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>lea rdx, [rdx+content-entry]</code> + <code>jmp</code></td>
<td style="text-align: left;">6</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>xor ecx, ecx</code> + <code>jmp</code></td>
<td style="text-align: left;">4</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>jmp [rel iatbl]</code></td>
<td style="text-align: left;">6</td>
</tr>
</tbody>
</table>
<p>è¿™æ ·å°±å¯ä»¥ä¸æ— ç”¨å­—æ®µé‡å äº†ã€‚</p>
<p>ä¿®æ”¹åçš„ <code>stretch.asm</code> å¦‚ä¸‹ï¼š</p>
<pre class="assembly"><code>BITS 64

                            ; DOS Header
    dw &#39;MZ&#39;                 ; e_magic
    dw 0                    ; [UNUSED] e_cblp
pe_hdr:                                                 ; PE Header
    dw &#39;PE&#39;                 ; [UNUSED] c_cp             ; Signature
    dw 0                    ; [UNUSED] e_crlc           ; Signature (Cont)
                                                        ; Image File Header
    dw 0x8664               ; [UNUSED] e_cparhdr        ; Machine
code:
symbol:                                                                                     ; Symbol
    dw 0x01                 ; [UNUSED] e_minalloc       ; NumberOfSections                  ; [UNUSED] Function Order
    db &#39;MessageBoxW&#39;, 0                                                                     ; Function Name
    times 14-($-symbol) db 0; [UNUSED] e_maxalloc       ; [UNUSED] TimeDateStamp
                            ; [UNUSED] e_ss             ; [UNUSED] TimeDateStamp (Cont)
                            ; [UNUSED] e_sp             ; [UNUSED] PointerToSymbolTable
                            ; [UNUSED] e_csum           ; [UNUSED] PointerToSymbolTable (Cont)
                            ; [UNUSED] e_ip             ; [UNUSED] NumberOfSymbols
                            ; [UNUSED] e_cs             ; [UNUSED] NumberOfSymbols (Cont)
    dw opt_hdr_size         ; [UNUSED] e_lfarlc         ; SizeOfOptionalHeader
    dw 0x22                 ; [UNUSED] e_ovno           ; Characteristics
opt_hdr:                                                ; Optional Header, COFF Standard Fields
    dw 0x020b               ; [UNUSED] e_res            ; Magic (PE32+)
    db 0                    ; [UNUSED] e_res (Cont)     ; [UNUSED] MajorLinkerVersion
    db 0                    ; [UNUSED] e_res (Cont)     ; [UNUSED] MinorLinkerVersion
    dd code_size            ; [UNUSED] e_res (Cont)     ; SizeOfCode
code_4:                                                                                     ; Code Fragment 4
    jmp [rel iatbl]                                                                         ; MessageBoxW
    times 8-($-code_4) db 0 ; [UNUSED] e_oemid          ; [UNUSED] SizeOfInitializedData
                            ; [UNUSED] e_oeminfo        ; [UNUSED] SizeOfInitializedData (Cont)
                            ; [UNUSED] e_res2           ; [UNUSED] SizeOfUninitializedData
    dd entry                ; [UNUSED] e_res2 (Cont)    ; AddressOfEntryPoint
    dd code                 ; [UNUSED] e_res2 (Cont)    ; BaseOfCode
                                                        ; Optional Header, NT Additional Fields
    dq 0x000140000000       ; [UNUSED] e_res2 (Cont)    ; ImageBase
    dd pe_hdr               ; e_lfanew                  ; [MODIFIED] SectionAlignment (0x10 -&gt; 0x04)
    dd 0x04                                             ; [MODIFIED] FileAlignment (0x10)
code_3:                                                                                     ; Code Fragment 3
    lea rdx, [rdx+content-entry]                                                            ; lpText
    jmp code_4
    times 8-($-code_3) db 0                             ; [UNUSED] MajorOperatingSystemVersion
                                                        ; [UNUSED] MinorOperatingSystemVersion
                                                        ; [UNUSED] MajorImageVersion
                                                        ; [UNUSED] MinorImageVersion
    dw 0x06                                             ; MajorSubsystemVersion
    dw 0                                                ; MinorSubsystemVersion
    dd 0                                                ; [UNUSED] Reserved1
    dd file_size                                        ; SizeOfImage
    dd hdr_size                                         ; SizeOfHeaders
    dd 0                                                ; [UNUSED] CheckSum
    dw 0x02                                             ; Subsystem (Windows GUI)
    dw 0x8160                                           ; DllCharacteristics
    dq 0x100000                                         ; SizeOfStackReserve
    dq 0x1000                                           ; SizeOfStackCommit
    dq 0x100000                                         ; SizeOfHeapReserve
dll_name:                                                                                   ; DLLName
    db &#39;USER32.dll&#39;, 0                                                                      ; DLLName
    times 12-($-dll_name) db 0                          ; [UNUSED] SizeOfHeapCommit
                                                        ; [UNUSED] LoaderFlags
    dd 0x02                                             ; [MODIFIED] NumberOfRvaAndSizes (0x10)

                            ; Optional Header, Data Directories
code_2:                                                 ; Code Fragment 2
    mov r9d, 0x00240040                                 ; uType
    jmp code_3
    times 8-($-code_2) db 0 ; [UNUSED] Export, RVA
                            ; [UNUSED] Export, Size
iatbl:                                                  ; Import Address Directory
    dd itbl                 ; Import, RVA               ; [USEDAFTERLOAD] DLLFuncEntry
    dd itbl_size            ; Import, Size              ; [USEDAFTERLOAD] DLLFuncEntry (Cont)
iatbl_size equ $-iatbl

opt_hdr_size equ $-opt_hdr

                            ; Section Table
    section_name db &#39;.&#39;, 0  ; Name
code_1:                                                 ; Code Fragment 1
    lea r8, [rdx+title-entry]                           ; lpCaption
    jmp code_2
    times 8-($-section_name) db 0
    dd sect_size            ; VirtualSize
    dd iatbl                ; VirtualAddress
    dd code_size            ; SizeOfRawData
    dd iatbl                ; PointerToRawData
content:                                                ; Strings
    db 0x41,0x00,0x42,0x00,0x43,0x00,0x44,0x00
    db 0x45,0x00,0x46,0x00,0x47,0x00,0,0
                            ; [UNUSED] PointerToRelocations
                            ; [UNUSED] PointerToLinenumbers
                            ; [UNUSED] NumberOfRelocations
                            ; [UNUSED] NumberOfLinenumbers
                            ; [UNUSED] Characteristics
hdr_size equ $-$$

title:
    db 0x3d,0xd8,0xaf,0xdc,0x20,0x00,0x54,0x00
    db 0x69,0x00,0x6e,0x00,0x79,0x00,0x50,0x00
    db 0x45,0x00,0x20,0x00,0x6f,0x00,0x6e,0x00
    db 0x20,0x00,0x57,0x00,0x69,0x00,0x6e,0x00
    db 0x64,0x00,0x6f,0x00,0x77,0x00,0x73,0x00
    db 0x20,0x00,0x31,0x00,0x30,0x00,0,0

itbl:                       ; Import Directory
    dq intbl                ; OriginalFirstThunk
entry:                                                  ; Code Fragment 0
    xor ecx, ecx                                        ; hWnd
    jmp code_1
    times 4-($-entry) db 0  ; [UNUSED] TimeDateStamp
    dd dll_name             ; ForwarderChain
    dd iatbl                ; Name
intbl:                                                  ; Import Name Table
    dq symbol               ; [UNUSED] FirstThunk       ; Symbol
itbl_size equ $-itbl
    dq 0                                                ; nullptr

sect_size equ $-code
code_size equ $-code
file_size equ $-$$</code></pre>
<p>ç¼–è¯‘ï¼š</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode zsh"><code class="sourceCode zsh"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>$ nasm -f bin -o stretch.exe -l stretch.lst stretch.asm</span></code></pre></div>
<p>ç¼–è¯‘ç”Ÿæˆ <code>stretch.exe</code>ï¼Œå¯ä»¥æ­£å¸¸è¿è¡Œã€‚</p>
<p><strong>ç¬¬ä¹æ­¥ï¼šåˆ é™¤æ–‡ä»¶æœ«å°¾çš„ 0ï¼Œå› ä¸ºç¨‹åºåŠ è½½æ—¶ä¼šåœ¨æœ«å°¾è‡ªåŠ¨å¡«å……é›¶ã€‚</strong></p>
<p>ç¨‹åºåŠ è½½æ—¶ä¼šåœ¨æœ«å°¾è‡ªåŠ¨å¡«å…… 0ï¼Œå› æ­¤æ–‡ä»¶æœ«å°¾çš„ 0 å¯ä»¥åˆ å»ã€‚</p>
<p>å°†ä¿®æ”¹åçš„ç»“æœä¿å­˜ä¸º <code>stretch.asm</code>ï¼š</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode zsh"><code class="sourceCode zsh"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>$ diff step8/stretch.asm step9/stretch.asm</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>113c113</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;</span>     dq symbol               ; [UNUSED] FirstThunk       ; Symbol</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="kw">&gt;</span>     dd symbol</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>115d114</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;</span>     dq 0                                                ; nullptr</span></code></pre></div>
<p>ç¼–è¯‘ï¼š</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode zsh"><code class="sourceCode zsh"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>$ nasm -f bin -o stretch.exe -l stretch.lst stretch.asm</span></code></pre></div>
<p>ç¼–è¯‘ç”Ÿæˆ <code>stretch.exe</code>ï¼Œå¯ä»¥æ­£å¸¸è¿è¡Œï¼š</p>
<p><img src="tiny1.exe.png" /></p>
<div class="sourceCode" id="cb20"><pre class="sourceCode zsh"><code class="sourceCode zsh"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>$ xxd stretch.exe</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>00000000: 4d5a 0000 5045 0000 6486 0100 4d65 7373  MZ..PE..d...Mess</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>00000010: 6167 6542 6f78 5700 8000 2200 0b02 0000  ageBoxW...<span class="st">&quot;.....</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="st">00000020: 0201 0000 ff25 6a00 0000 0000 fc00 0000  .....%j.........</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="st">00000030: 0a00 0000 0000 0040 0100 0000 0400 0000  .......@........</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="st">00000040: 0400 0000 488d 52b8 ebda 0000 0600 0000  ....H.R.........</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="st">00000050: 0000 0000 0c01 0000 c400 0000 0000 0000  ................</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="st">00000060: 0200 6081 0000 1000 0000 0000 0010 0000  ..</span><span class="kw">`</span>.............</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>00000070: 0000 0000 0000 1000 0000 0000 5553 4552  ............USER</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>00000080: 3332 2e64 6c6c 0000 0200 0000 41b9 4000  32.dll......A.@.</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>00000090: 2400 ebb0 f400 0000 1800 0000 2e00 4c8d  $.............L.</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>000000a0: 42c8 ebe8 0201 0000 9400 0000 0201 0000  B...............</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>000000b0: 9400 0000 4100 4200 4300 4400 4500 4600  ....A.B.C.D.E.F.</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>000000c0: 4700 0000 3dd8 afdc 2000 5400 6900 6e00  G...=..<span class="kw">.</span> .T.i.n.</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>000000d0: 7900 5000 4500 2000 6f00 6e00 2000 5700  y.P.E<span class="kw">.</span> .o.n<span class="kw">.</span> .W.</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>000000e0: 6900 6e00 6400 6f00 7700 7300 2000 3100  i.n.d.o.w.s<span class="kw">.</span> .1.</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>000000f0: 3000 0000 0801 0000 0000 0000 31c9 eb9e  0...........1...</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>00000100: 7c00 0000 9400 0000 0a00 0000            <span class="kw">|</span>...........</span></code></pre></div>
<h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2>
<p>é™¤æ–‡ä¸­å·²è¯´æ˜çš„å‚è€ƒèµ„æ–™å¤–ï¼Œæœ¬å®éªŒè¿˜å‚è€ƒäº†ä»¥ä¸‹èµ„æ–™ï¼š</p>
<ol type="1">
<li><a href="http://www.phreedom.org/research/tinype/">Tiny PE</a></li>
<li><a href="https://keyj.emphy.de/win32-pe/">Writing ultra-small Windows executables</a></li>
</ol>
<p>ï¼ˆä½œäº 2019 å¹´ä¸­æœŸï¼Œå‘å¸ƒäº 2021â€¯å¹´â€¯11â€¯æœˆâ€¯23â€¯æ—¥ï¼‰</p>
</body>
</html>
